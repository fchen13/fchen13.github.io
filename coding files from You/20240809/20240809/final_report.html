<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>finalReport</title>
    <script src="./echarts.min.js"></script>
    <script src="./utils.js"></script>
    <script src="./services.js"></script>
    <script src="./projectsMap.js"></script>
    <style>
        #chartContainer {
            height: 60vh;
            width: 60%;
            /* min-width: 500px;    */
            margin: 20px auto;
        }
    </style>
  </head>
  <body>
   <div id="chartContainer"></div>

    <script>
        let chartInstance = null
      window.onload = function () {
        const finalReportUrl = 'https://goat.genomehubs.org/api/v2/report?report=histogram&x=tax_tree%282759%29%20AND%20long_list%20AND%20bioproject%3DPRJNA533106&rank=species&includeEstimates=false&cat=assembly_level%3Dcontig%2Cscaffold%2Cchromosome%2Ccomplete%20genome&xOpts=%2C%2C55%2C%2CEBP%20Affiliate&caption=Assemblies%20available%20on%20INSDC%20for%20target%20species%20across%20EBP-affiliated%20projects.%20Note%20that%20umbrella%20projects%20will%20inherit%20counts%20from%20their%20sub-projects%20and%20that%20overlapping%20targets%20sequenced%20by%20at%20least%20one%20EBP%20affiliate%20will%20appear%20as%20complete%20in%20all%20projects%20targeting%20that%20taxon&taxonomy=ncbi&result=taxon&queryId=vLCkKyxY2S'
        fetchData(finalReportUrl).then(res => {
            const categories = res.report.report.histogram.histograms.buckets.filter(item => (!!item))
            const requests = []
            const validCategories = []
            categories.forEach(projectName => {
                const projectId = projectsMap[projectName]
                if(projectId) {
                    const url = `https://goat.genomehubs.org/api/v2/report?report=histogram&x=bioproject%3D${projectId}&rank=species&cat=assembly_level%3Dcontig%2Cscaffold%2Cchromosome%2Ccomplete%20genome&includeEstimates=true&excludeAncestral%5B0%5D=bioproject&excludeMissing%5B0%5D=bioproject&xOpts=${projectId}%2C%2C1%2C%2C&caption=Assembly%20level%20of%20AG100PEST%20genomes&taxonomy=ncbi&result=taxon&queryId=2_ayC5oMSb`
                    requests.push(fetchData(url))
                    validCategories.push(projectName)
                }
            })
            const byCats = {
                'chromosome': [],
                'complete genome': [],
                'contig': [],
                'scaffold': []
            }
            const cats = []
            Promise.all(requests).then(results => {
                results.forEach((res, index) => {
                    if(!res.report.report.histogram.histograms) return
                    const byCat = res.report.report.histogram.histograms.byCat
                    Object.keys(byCat).forEach(key => {
                        byCats[key].push(byCat[key][0])
                    })
                    cats.push(validCategories[index])
                })
                const myData = {
                    report: {
                        report: {
                            yLabel: "Count of species",
                            histogram: {
                                histograms: {
                                    byCat: byCats,
                                    buckets: []
                                }
                            }
                        }
                    }
                }
                const { series } = getDefaultStackedBarData(myData)
                const title = 'Count of species'
                chartInstance = initEchart({series, categories: cats}, 'chartContainer', title)
                window.onresize = chartInstance.resize
            })
        })
      };

      function initEchart(data, containerId, yLabel) {
        const chartDom = document.getElementById(containerId);
        const myChart = echarts.init(chartDom);

        const option = {
          legend: {
            show: true,
            selectedMode: false,
            data: ['contig', 'scaffold', 'chromosome', 'complete genome'], // Reorder legend items
            textStyle: {
              color: '#000',
              fontSize: 12,
              fontWeight: 'bold',
            }
          },
          color: ['#FF0000', '#00FF00', '#0000FF', '#FFA500'], // Higher contrast colors with distinct color for complete genome
          grid: {
            left: '7%',  // Decreased left margin
            right: '2%',
            bottom: '3%',
            containLabel: true
          },
          yAxis: {
            type: "value",
            name: yLabel,
            nameLocation: 'middle',
            nameRotate: 90,
            nameGap: 45,  // Adjust gap to bring label closer
            nameTextStyle: {
              fontWeight: 'bold',
              fontSize: 14,
            },
            axisLine: {
              show: true,
              lineStyle: {
                color: "#000",
                width: 1,
              },
            },
            axisLabel: {
              show: true,
              color: "#000",
              fontSize: 12,
              margin: 5, // Move labels closer to the axis
            },
            splitLine: {
              show: true,
              lineStyle: {
                color: '#ccc'
              }
            },
          },
          xAxis: {
            type: "category",
            data: data.categories, // Create an array of years from 2006 to 2024
            axisLine: {
              show: true,
              lineStyle: {
                color: "#000",
                width: 1,
              },
              
            },
            axisLabel: {
              show: true,
              color: "#000",
              fontSize: 12,
              rotate: 90,
            //   fontFamily: 'Times News Roman' 
            // fontWeight: 700
            },
            splitLine: {
              show: false,
            },
          },
          tooltip: {
            trigger: "axis",
            formatter: function (params) {
              var res = params
                .map(function (item) {
                  return item.seriesName + ": " + item.value; // Show percentage only in specific containers
                })
                .join("<br/>");

              // For total calculation
              var categoryMap = {};
                params.forEach(function (item) {
                  var category = item.name;
                  var value = item.value;

                  if (!categoryMap[category]) {
                    categoryMap[category] = 0;
                  }

                  categoryMap[category] += value;
                });

                var totalStr = "";
                for (var category in categoryMap) {
                  totalStr += "Total (" + category + "): " + categoryMap[category] + "<br/>";
                }
                return res + "<br/>" + totalStr;

              return res;
            },
          },
          series: data.series,
        };
        myChart.setOption(option);
      
        return myChart
      }
    </script>
  </body>
</html>
