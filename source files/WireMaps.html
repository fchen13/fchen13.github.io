<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="copyright" content="© 2025 The Earth BioGenome Project" />
    <meta name="author" content="Fang Chen" />
    <title>EBP Network Connections</title>
    <script src="../config.js"></script>
    <script src="./echarts.min.js"></script>
    <script src="./geoMap/world.zh.js"></script>
    <!-- 替换为新的JS数据文件 -->
    <script src="./geoMap/EBPnetwork_20250513.js"></script>
    <link href="./geoMap/bootstrap.min.css" rel="stylesheet" />
    <script src="./geoMap/jquery-3.6.0.min.js"></script>
    <script src="./geoMap/popper.min.js"></script>
    <script src="./geoMap/bootstrap.min.js"></script>
    <style>
    * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      body {
          margin: 0;
          padding: 0;
          overflow: hidden;
      }        
      #mapContainer {
        flex-grow: 1;
        overflow: hidden;
        background-color: #b1c6ca;
        height: 100vh;
      }

      /* Add styles for the wrapper */
      #mainLayout {
        display: flex;
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
      }

      /* Footer styles */
      #footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: rgba(248, 249, 250, 0.95);
        color: #333;
        text-align: center;
        padding: 5px;
        z-index: 9999;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        font-size: 14px;
        display: none;
      }

      /* Filter Panel styles */
      #filterPanel {
        width: 250px;
        height: 100vh;
        background-color: #464f4f;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        overflow-y: auto;
        flex-shrink: 0;
      }

      .filter-group {
        margin-bottom: 15px;
      }

      .filter-group:last-child {
        margin-bottom: 0;
      }

      .filter-group h3 {
        margin-bottom: 10px;
        font-size: 16px;
        color: #f3f3f3;
      }

      .filter-item {
        margin: 5px 0;
        display: flex;
        align-items: center;
      }

      .filter-item input[type="checkbox"] {
        margin-right: 8px;
        accent-color: #f3f3f3;
      }

      .filter-item label {
        font-size: 14px;
        cursor: pointer;
        color: #f3f3f3;
      }

      .filter-item label:hover {
        color: #ffffff;
      }

      .select-all {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }

      .select-all label {
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="mainLayout">
        <div id="mapContainer"></div>
        <div id="filterPanel">
          <div class="filter-group">
            <div id="centerFilters"></div>
          </div>
          <div class="filter-group">
            <h3>Regional Nodes</h3>
            <div id="regionalNodeFilters"></div>
          </div>
          <div class="filter-group">
            <h3>Affiliated Projects</h3>
            <div id="headquartersFilters"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="copyright">© 2025 Earth BioGenome Project</div>
    </div>
    <script>
      function initMap(worldJson) {
        const data = projectsData;

        // Debug logging for headquarters
        console.log("Headquarters projects:", data.filter(item => item.type === "Headquarters").map(item => item.projectName));

        const addressMap = {};
        const aggregatedData = data.map((item) => {
          const address = item.address;
          item.name =
            (item.type === "Headquarters" || item.type === "Node") ? item.projectName : item.institution;
          addressMap[address] = (addressMap[address] || 0) + 1;

          const offsetX =
            addressMap[address] > 1 ? ((Math.random() - 0.5) * 2) / 5 : 0;
          const offsetY =
            addressMap[address] > 1 ? ((Math.random() - 0.5) * 2) / 5 : 0;

          const point = {
            name: item.projectName,
            value: [
              item.longitude + offsetX,
              item.latitude + offsetY,
              addressMap[address],
            ],
            type: item.type,
            website: item.website,
            isCenter: item.type === "Center",
            symbolSize:
              item.type === "Center" ? 8 : item.type === "Node" ? 8 : item.type === "Headquarters" ? 5 : 4,
            itemStyle: {
              color: "#303030",
              borderColor:
                item.type === "Headquarters"
                  ? "transparent"
                  : item.type === "Center"
                  ? "#dbc649"
                  : item.type === "Node"
                  ? "#dbc649"
                  : "transparent",
              borderWidth: 3,
              opacity: 1,
            },
            rawData: item,
            visible: true, // Add visibility state
          };
          
          return point;
        });

        // Filter to show only headquarters and center points
        const filteredData = aggregatedData.filter(
          (point) => point.type === "Headquarters" || point.type === "Center" || point.type === "Node"
        );

        // Find center point
        const center = aggregatedData.find((point) => point.type === "Center");

        // Create filter checkboxes
        const centerFilters = document.getElementById('centerFilters');
        const regionalNodeFilters = document.getElementById('regionalNodeFilters');
        const headquartersFilters = document.getElementById('headquartersFilters');

        // Add center filter (EBP Secretariat)
        const centerCheckbox = document.createElement('div');
        centerCheckbox.className = 'filter-item';
        centerCheckbox.innerHTML = `
          <input type="checkbox" id="center-${center.name}">
          <label for="center-${center.name}">${center.name}</label>
        `;
        centerFilters.appendChild(centerCheckbox);

        // Add Regional Node filter (ERGA)
        console.log('All nodes:', aggregatedData.map(p => ({name: p.name, type: p.type})));
        const ergaNode = aggregatedData.find(point => point.name === "European Reference Genome Atlas (ERGA)" && point.type === "Node");
        let ergaCheckbox = null;
        if (ergaNode) {
          ergaCheckbox = document.createElement('div');
          ergaCheckbox.className = 'filter-item';
          ergaCheckbox.innerHTML = `
            <input type="checkbox" id="regional-ERGA">
            <label for="regional-ERGA">European Reference Genome Atlas (ERGA)</label>
          `;
          regionalNodeFilters.appendChild(ergaCheckbox);
        }

        // Add headquarters filters
        filteredData
          .filter(point => point.type === "Headquarters")
          .forEach(point => {
            const checkbox = document.createElement('div');
            checkbox.className = 'filter-item';
            checkbox.innerHTML = `
              <input type="checkbox" id="headquarters-${point.name}">
              <label for="headquarters-${point.name}">${point.name}</label>
            `;
            headquartersFilters.appendChild(checkbox);
          });

        // Set initial visibility to false for all points
        filteredData.forEach(point => {
          point.visible = false;
        });
        
        // Set ERGA node to be invisible by default
        if (ergaNode) {
          ergaNode.visible = false;
        }

        // Prepare ERGA logic
        const ERGA_AFFILIATES = [
          "ERGA-25GP", "ERGA-BGE", "ERGA-CH", "ERGA-COM", "ERGA-FR", "ERGA-PIL",
          "Project Psyche", "An Atlas of Eukaryotic Marine Genomes (ATLASea)", "Darwin Tree of Life (DToL)", "Catalan Initiative for the Earth BioGenome Project (CBP)", "Italian Endemics (ENDEMIXIT)"
        ];
        // Find headquarters points for these affiliates
        const ergaAffiliatePoints = filteredData.filter(p => ERGA_AFFILIATES.includes(p.name));
        // Precompute ERGA links
        let ergaLinks = [];
        if (ergaNode) {
          ergaLinks = ergaAffiliatePoints.map(point => ({
            fromName: ergaNode.name,
            toName: point.name,
            coords: [ [ergaNode.value[0], ergaNode.value[1]], point.value ],
            lineStyle: {
              normal: {
                curveness: point.value[0] >= ergaNode.value[0] ? 0.4 : -0.4,
                color: "#dbc649",
                width: 1.5,
                opacity: 0.7,
              },
            },
            visible: false,
          }));
        }

        // 预生成所有连接线
        const allLinks = aggregatedData
          .filter((point) => point.type === "Headquarters")
          .map((point) => ({
            fromName: center.name,
            toName: point.name,
            coords: [center.value, point.value],
            lineStyle: {
              normal: {
                curveness: point.value[0] >= center.value[0] ? 0.4 : -0.4,
                color: "#303030",
                width: 1,
                opacity: 0.5,
              },
            },
            visible: false, // Set initial visibility to false
          }));

        const myChart = echarts.init(document.getElementById("mapContainer"));
        echarts.registerMap("world", worldJson);

        // Store current zoom level
        let currentZoom = 1.1;
        let currentCenter = [0, 10];

        // Function to update visualization based on filter state
        function updateVisualization() {
          const visiblePoints = filteredData.filter(point => point.visible);
          const visibleLinks = allLinks.filter(link => {
            const fromPoint = filteredData.find(p => p.name === link.fromName);
            const toPoint = filteredData.find(p => p.name === link.toName);
            return fromPoint && toPoint && fromPoint.visible && toPoint.visible;
          });

          // Add ERGA node and links if selected
          let visibleRegionalNodes = [];
          let visibleRegionalLinks = [];
          if (ergaNode && ergaNode.visible) {
            visibleRegionalNodes.push({
              ...ergaNode,
              value: [ergaNode.value[0], ergaNode.value[1], 1],
              symbolSize: 6,
              symbol: 'circle',
              zlevel: 6,
              itemStyle: { 
                color: "#303030",
                borderColor: "#dbc649",
                borderWidth: 2,
                opacity: 1 
              },
            });
            
            // Add ERGA links for visible affiliate points
            visibleRegionalLinks = ergaAffiliatePoints
              .filter(point => point.visible)
              .map(point => ({
                fromName: ergaNode.name,
                toName: point.name,
                coords: [ [ergaNode.value[0], ergaNode.value[1]], point.value ],
                lineStyle: {
                  normal: {
                    curveness: point.value[0] >= ergaNode.value[0] ? 0.4 : -0.4,
                    color: "#303030",
                    width: 1,
                    opacity: 0.5,
                  },
                },
              }));
          }

          // Add visible site points and their connections
          const visibleSitePoints = [];
          const visibleSiteLinks = [];

          // Check if EBP Secretariat is selected
          const center = filteredData.find(p => p.type === "Center");
          const isCenterSelected = center && center.visible;
          // Check if ERGA is selected
          const isErgaSelected = ergaNode && ergaNode.visible;
          
          // Only show sites and their connections if EBP Secretariat is not selected and ERGA is not selected
          if (!isCenterSelected && !isErgaSelected) {
            const visibleHeadquarters = filteredData.filter(p => p.type === "Headquarters" && p.visible);
            visibleHeadquarters.forEach(headquarters => {
              // Find associated sites
              const relatedSites = aggregatedData.filter(
                node => node.rawData.projectName.toLowerCase() === headquarters.rawData.projectName.toLowerCase() &&
                       node.type === "Site"
              );
              // Add visible sites
              visibleSitePoints.push(...relatedSites);
              // Add connections from headquarters to sites
              const siteLinks = relatedSites.map(site => ({
                fromName: headquarters.name,
                toName: site.name,
                coords: [headquarters.value, site.value],
                lineStyle: {
                  normal: {
                    curveness: site.value[0] >= headquarters.value[0] ? 0.4 : -0.4,
                    color: "#303030",
                    width: 1,
                    opacity: 0.4,
                  },
                },
              }));
              visibleSiteLinks.push(...siteLinks);
            });
          }

          console.log('ERGA wires:', visibleRegionalLinks);
          console.log('ECharts option:', {
            scatter: [...visiblePoints, ...visibleSitePoints, ...visibleRegionalNodes],
            lines: [...visibleLinks, ...visibleSiteLinks, ...visibleRegionalLinks]
          });
          myChart.setOption({
            tooltip: {
              trigger: "item",
              formatter: (params) => {
                if (params.seriesType === "scatter") {
                  const item = params.data;
                  let tooltipContent = `<strong>${item.name}</strong><br/>`;
                  
                  // Add institution if available
                  if (item.rawData.institution) {
                    tooltipContent += `Institution: ${item.rawData.institution}`;
                  }
                  
                  return tooltipContent;
                }
                return null;
              },
            },
            geo: {
              map: "world",
              roam: true,
              label: { show: false },
              itemStyle: {
                normal: { areaColor: "#f3f3f3", borderColor: "#999" },
                emphasis: { areaColor: "#FFFF00" },
              },
              center: currentCenter,
              zoom: currentZoom
            },
            series: [
              {
                type: "scatter",
                coordinateSystem: "geo",
                data: [...visiblePoints, ...visibleSitePoints, ...visibleRegionalNodes],
                symbolSize: function (val) {
                  const point = val[2] ? [...visiblePoints, ...visibleSitePoints, ...visibleRegionalNodes].find(p => p.value[0] === val[0] && p.value[1] === val[1]) : null;
                  if (point && point.type === "Headquarters") return 5;
                  if (point && point.type === "Center") return 9;
                  if (point && point.type === "Node") return 8;
                  return 4;
                },
              },
              {
                type: "lines",
                data: [...visibleLinks, ...visibleSiteLinks, ...visibleRegionalLinks],
                lineStyle: {
                  normal: {
                    color: "#303030",
                    width: 1,
                    opacity: 0.5,
                    curveness: 0.4,
                  },
                },
              }
            ]
          });
        }

        // Function to update headquarters visibility based on EBP Secretariat state
        function updateHeadquartersVisibility(centerVisible) {
          const headquartersCheckboxes = document.querySelectorAll('#headquartersFilters input[type="checkbox"]');
          headquartersCheckboxes.forEach(checkbox => {
            checkbox.checked = centerVisible;
          });
          
          filteredData
            .filter(point => point.type === "Headquarters")
            .forEach(point => {
              point.visible = centerVisible;
            });
          
          // Update all headquarters wire connections
          allLinks.forEach(link => {
            link.visible = centerVisible;
          });
        }

        // Add event listeners for individual checkboxes
        document.querySelectorAll('#filterPanel input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const isCenter = e.target.id.startsWith('center-');
            const isRegional = e.target.id.startsWith('regional-');
            const projectName = e.target.id.replace(isCenter ? 'center-' : isRegional ? 'regional-' : 'headquarters-', '');
            if (isRegional && projectName === 'ERGA') {
              // Handle ERGA logic
              if (ergaNode) ergaNode.visible = e.target.checked;
              ergaAffiliatePoints.forEach((point, i) => {
                // Set affiliate checkboxes and visibility
                const cb = document.getElementById('headquarters-' + point.name);
                if (cb) cb.checked = e.target.checked;
                point.visible = e.target.checked;
                // Set ERGA link visibility
                if (ergaLinks[i]) ergaLinks[i].visible = e.target.checked;
              });
              updateVisualization();
              return;
            }
            const point = filteredData.find(p => p.name === projectName);
            if (point) {
              if (isCenter) {
                // If EBP Secretariat checkbox is clicked
                point.visible = e.target.checked;
                updateHeadquartersVisibility(e.target.checked);
              } else {
                // If a headquarters checkbox is clicked
                point.visible = e.target.checked;
              }
              updateVisualization();
            }
          });
        });

        // Initial visualization update
        updateVisualization();

        // 交互逻辑
        myChart.on("mouseover", function (params) {
          if (params.seriesType === "scatter") {
            const item = params.data;

            // 总部悬停显示关联站点
            if (item.type === "Headquarters") {
              const relatedSite = aggregatedData.filter(
                (node) =>
                  node.rawData.projectName.toLowerCase() === item.rawData.projectName.toLowerCase() &&
                  node.type === "Site"
              );
              const data = filteredData.find((node) => node.name === item.name);
              data.itemStyle.borderColor = "#dbc649";
              const links = relatedSite.map((point) => ({
                fromName: item.name,
                toName: point.name,
                coords: [item.value, point.value],
                lineStyle: {
                  normal: {
                    curveness: point.value[0] >= item.value[0] ? 0.4 : -0.4,
                  },
                },
              }));
              myChart.setOption({
                series: [
                  {
                    type: "scatter",
                    data: [...filteredData.filter(p => p.visible), ...relatedSite],
                    symbolSize: function (val) {
                      return val.type === "Site"
                        ? 4
                        : val.type === "Headquarters"
                        ? 5
                        : 9;
                    },
                  },
                  {
                    type: "lines",
                    data: links,
                    lineStyle: {
                      normal: {
                        color: "#303030",
                        width: 1,
                        opacity: 0.5,
                        curveness: 0.4,
                      },
                    },
                  },
                ],
              });
            }

            // 中心点悬停显示全局飞线
            if (item.type === "Center") {
              const visibleLinks = allLinks.filter(link => {
                const toPoint = filteredData.find(p => p.name === link.toName);
                return toPoint && toPoint.visible;
              });
              myChart.setOption({
                series: [
                  { type: "scatter", data: filteredData.filter(p => p.visible) },
                  {
                    type: "lines",
                    data: visibleLinks,
                    lineStyle: {
                      normal: {
                        color: "#303030",
                        width: 1,
                        opacity: 0.5,
                        curveness: 0.4,
                      },
                    },
                  },
                ],
              });
            }
          }
        });

        myChart.on("mouseout", function (params) {
          if (params.seriesType === "scatter") {
            const item = params.data;
            if (item.type === "Headquarters") {
              const data = filteredData.find((node) => node.name === item.name);
              data.itemStyle.borderColor = "transparent";
              updateVisualization();
            }
          }
        });

        // Add event listener for zoom and pan
        myChart.on('georoam', function (params) {
          const option = myChart.getOption();
          currentZoom = option.geo[0].zoom;
          currentCenter = option.geo[0].center;
        });
      }

      // Initialize map
      initMap(worldJson);

      // 版权信息
      if (typeof copyright !== "undefined") {
        document.getElementById("copyright").textContent = copyright.notice;
      }
    </script>
  </body>
</html>
