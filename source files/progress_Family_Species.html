<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <meta name="copyright" content="Data source: Genomes on a Tree (GoaT). Used with permission." /> -->
    <meta name="author" content="Fang Chen" />
    <title>EBP Progress</title>
    <script src="../config.js"></script>
    <script src="./echarts.min.js"></script>
    <script src="./utils.js"></script>
    <script src="./services.js"></script>
    <style>
      .page-title {
        text-align: center;
        font-weight: bold;
        margin: 5vh 0 0 0 !important;
        color: #333;
        letter-spacing: 1px;
        padding: 0;
        font-size: 1.6vw;
        min-font-size: 18px;
      }
      .container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 0vw;
        padding-bottom: 1vh;
        margin-top: 10vh;
        width: 100vw;
        max-width: 100vw;
        box-sizing: border-box;
      }
      .column {
        flex: 1 1 400px; /* Grow, shrink, min width */
        min-width: 320px;
        max-width: 700px;
        box-sizing: border-box;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      .chart-container {
        width: 100%;
        aspect-ratio: 16/9;
        min-height: 300px;
        max-height: 70vh;
        margin: 0 auto 2vh auto;
        position: relative;
      }

      /* Footer styles */
      #footer {
        position: fixed;
        bottom: 0;
        width: 100vw;
        background-color: rgba(248, 249, 250, 0.95);
        color: #333;
        text-align: center;
        padding: 0.5vh 0;
        z-index: 9999;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        font-size: 1.1vw;
        min-font-size: 12px;
        font-family: Arial, sans-serif;
      }

      /* Container for centering and styling */
      .select-container {
        display: flex;
        justify-content: right;
        align-items: center;
        margin: 0px 10px 0 0;  /* Changed from -30px to -20px to move it down */
        position: relative;
        z-index: 1;  /* Ensure it stays above other elements */
      }

      /* Custom select style */
      .custom-select {
        position: relative;
        display: inline-block;
        width: 200px;
      }

      .select-box {
        appearance: none;
        background-color: #ffffff;
        border: 2px solid #cccccc;
        border-radius: 8px;
        padding: 5px 20px;  /* Reduced vertical padding from 10px to 5px */
        font-size: 16px;
        color: #333333;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        width: 100%;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        height: 32px;  /* Added fixed height */
        line-height: 20px;  /* Added line height for vertical centering */
      }

      .select-box::after {
        content: 'â–¼';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        color: #888888;
      }

      .select-box:hover,
      .select-box:focus {
        border-color: #666666;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* Dropdown list */
      .options-container {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: #ffffff;
        border: 2px solid #cccccc;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 999;
      }

      .option {
        padding: 5px 20px;  /* Reduced padding to match select box */
        font-size: 16px;
        color: #333333;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-family: Arial, sans-serif;
        line-height: 20px;  /* Added line height for consistency */
      }

      .option:hover {
        background-color: #f0f0f0;
      }

      /* Show options on click */
      .custom-select.active .options-container {
        display: block;
      }

      @media (max-width: 900px) {
        .container {
          flex-direction: column;
          gap: 2vh;
        }
        .column {
          max-width: 100vw;
        }
        .page-title {
          font-size: 4vw;
        }
      }

      @media (min-width: 2000px) {
        .chart-container {
          max-width: 1200px;
          max-height: 60vh;
        }
        .page-title {
          font-size: 1.5vw;
        }
      }
    </style>
  </head>
  <body>
    <h1 class="page-title">Progress of EBP over years</h1>
    <div class="select-container">
      <div class="custom-select">
        <div class="select-box">Cumulative</div>
        <div class="options-container">
          <div class="option">Cumulative</div>
          <div class="option">Actual</div>
          <div class="option">YoY Growth</div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="column">
        <!-- Species Progress -->
        <!-- <div id="speciesProgressContainer1" class="chart-container"></div>
        <div id="speciesProgressContainer2" class="chart-container"></div>
        <div id="speciesProgressContainer3" class="chart-container"></div> -->
        <div id="speciesProgressContainer" class="chart-container"></div>
      </div>
      <div class="column">
        <!-- Family Progress -->
        <!-- <div id="familyProgressContainer1" class="chart-container"></div>
        <div id="familyProgressContainer2" class="chart-container"></div>
        <div id="familyProgressContainer3" class="chart-container"></div> -->
        <div id="familyProgressContainer" class="chart-container"></div>
      </div>
    </div>

    <div id="footer">
        <div id="copyright">Data source: Genomes on a Tree (GoaT). Used with permission.</div>
    </div>

    <script>
      const familyDataMap = {}
      const speciesDataMap = {}
      let activeType = 'Cumulative'
      let familyChart = null
      let speciesChart = null
      window.onload = function () {
        // Family Progress
        const familyUrl = "https://goat.genomehubs.org/api/v2/report?report=histogram&x=min%28assembly_date%29%20AND%20bioproject%3DPRJNA533106&result=taxon&cat=assembly_level%3Dcontig%2Cscaffold%2Cchromosome%2Ccomplete%20genome&stacked=true&cumulative=true&includeEstimates=true&rank=Family&xOpts=2002%2C%2C1%2C%2CAssembly%20date&caption=Cumulative%20number%20of%20eukaryotic%20families%20for%20which%20assemblies%20were%20generated%20by%20EBP%20affiliates%20over%20time&taxonomy=ncbi";
        getStackedBarData(familyUrl).then(({formatData, defaultData, percentData}) => {
          // initEchart(formatData, 'familyProgressContainer1', 'Count of families (Cumulative)');
          // initEchart(defaultData, 'familyProgressContainer2', 'Count of families (Actual)');
          // initEchart(percentData, 'familyProgressContainer3', 'Count of families (YoY Growth)');
          familyDataMap['Cumulative'] = formatData
          familyDataMap['Actual'] = defaultData
          familyDataMap['YoY Growth'] = percentData
          familyChart = initEchart(familyDataMap[activeType], 'familyProgressContainer', `Count of families (${activeType})`);
        });

        // Species Progress
        const speciesUrl = "https://goat.genomehubs.org/api/v2/report?report=histogram&x=min%28assembly_date%29%20AND%20bioproject%3DPRJNA533106%20AND%20tax_rank%28species%29&rank=species&result=taxon&cat=assembly_level%5B4%5D%3Dchromosome%2Cscaffold%2Ccontig%2Ccomplete%20genome&includeEstimates=true&excludeAncestral%5B0%5D=bioproject&excludeMissing%5B0%5D=bioproject&stacked=true&cumulative=true&xOpts=2002%2C%2C2%2C%2CAssembly%20date&caption=Cumulative%20number%20of%20assemblies%20for%20eukaryotic%20species%20generated%20by%20EBP%20affiliates%20over%20time&taxonomy=ncbi";
        getStackedBarData(speciesUrl).then(({formatData, defaultData, percentData}) => {
          // initEchart(formatData, 'speciesProgressContainer1', 'Count of species (Cumulative)');
          // initEchart(defaultData, 'speciesProgressContainer2', 'Count of species (Actual)');
          // initEchart(percentData, 'speciesProgressContainer3', 'Count of species (YoY Growth)');
          speciesDataMap['Cumulative'] = formatData
          speciesDataMap['Actual'] = defaultData
          speciesDataMap['YoY Growth'] = percentData
          speciesChart = initEchart(speciesDataMap[activeType], 'speciesProgressContainer', `Count of species (${activeType})`);
        });
      };

      function checkoutChart(type) {
        if(activeType === type) return;
        const familyOption = familyChart.getOption();
        const speciesOption = speciesChart.getOption();
        familyOption.yAxis[0].name = `Count of families (${type})`;
        speciesOption.yAxis[0].name = `Count of species (${type})`;
        familyOption.series = familyDataMap[type].series
        speciesOption.series = speciesDataMap[type].series
        familyChart.setOption(familyOption);
        speciesChart.setOption(speciesOption, );
        activeType = type
      }

      function initEchart(data, containerId, yLabel) {
        const chartDom = document.getElementById(containerId);
        const myChart = echarts.init(chartDom);

        const option = {
          legend: {
            show: true,
            selectedMode: false,
            data: ['contig', 'scaffold', 'chromosome', 'complete genome'], // Reorder legend items
            textStyle: {
              color: '#000',
              fontSize: 12,
              fontWeight: 'bold',
            }
          },
          color: ['#FF0000', '#00FF00', '#0000FF', '#FFff33'], // Higher contrast colors with distinct color for complete genome
          grid: {
            left: '7%',  // Decreased left margin
            right: '2%',
            bottom: '3%',
            containLabel: true
          },
          yAxis: {
            type: "value",
            name: yLabel,
            nameLocation: 'middle',
            nameRotate: 90,
            nameGap: 45,  // Adjust gap to bring label closer
            nameTextStyle: {
              fontWeight: 'bold',
              fontSize: 14,
            },
            axisLine: {
              show: true,
              lineStyle: {
                color: "#000",
                width: 1,
              },
            },
            axisLabel: {
              show: true,
              color: "#000",
              fontSize: 12,
              margin: 5, // Move labels closer to the axis
            },
            splitLine: {
              show: true,
              lineStyle: {
                color: '#ccc'
              }
            },
          },
          xAxis: {
            type: "category",
            data: containerId === 'familyProgressContainer'
              ? Array.from({length: 2025 - 2004 + 1}, (_, i) => 2004 + i) // Family: 2004-2025
              : Array.from({length: 2025 - 2002 + 1}, (_, i) => 2002 + i), // Species: 2002-2025
            axisLine: {
              show: true,
              lineStyle: {
                color: "#000",
                width: 1,
              },
            },
            axisLabel: {
              show: true,
              color: "#000",
              fontSize: 12,
              interval: function(index, value) {
                // Show label only if the year is even (2006, 2008, 2010, etc.)
                return parseInt(value) % 2 === 0;
              },
              rotate: 0,  // Rotate labels for better readability
            },
            splitLine: {
              show: false,
            },
          },
          tooltip: {
            trigger: "axis",
            formatter: function (params) {
              // For total calculation
              if (!activeType.includes('YoY Growth')) {
                var categoryMap = {};
                params.forEach(function (item) {
                  var category = item.name;
                  var value = item.value;

                  if (!categoryMap[category]) {
                    categoryMap[category] = 0;
                  }

                  categoryMap[category] += value;
                });

                var totalStr = "";
                for (var category in categoryMap) {
                  totalStr += "Total (" + category + "): " + categoryMap[category].toLocaleString() + "<br/>";
                }

                var res = params
                  .map(function (item) {
                    return item.seriesName + ": " + item.value.toLocaleString();
                  })
                  .join("<br/>");

                return totalStr + res;
              }

              var res = params
                .map(function (item) {
                  return item.seriesName + ": " + item.value.toLocaleString() + (activeType.includes('YoY Growth') ? '%' : '');
                })
                .join("<br/>");

              return res;
            },
          },
          series: data.series,
        };
        myChart.setOption(option);
      
        return myChart
      }

       // JavaScript to handle dropdown functionality
    document.querySelector('.select-box').addEventListener('click', function() {
      const select = this.parentElement;
      select.classList.toggle('active');
    });

    document.querySelectorAll('.option').forEach(option => {
      option.addEventListener('click', function() {
        const selectBox = option.parentElement.previousElementSibling;
        selectBox.textContent = option.textContent;
        selectBox.parentElement.classList.remove('active');
        checkoutChart(option.textContent)
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const select = document.querySelector('.custom-select');
      if (!select.contains(event.target)) {
        select.classList.remove('active');
      }
    });

    // Add copyright notice with fallback
    try {
      const copyrightElement = document.getElementById('copyright');
      if (window.copyright && window.copyright.notice) {
        copyrightElement.textContent = copyright.notice;
      }
    } catch (e) {
      console.warn('Copyright configuration not loaded:', e);
    }

    function fillMissingBins(rawData, totalBins) {
      const filled = new Array(totalBins).fill(0);
      for (let i = 0; i < rawData.length; i++) {
        filled[i] = rawData[i];
      }
      return filled;
    }

    // In your data processing:
    const totalBins = category.length;
    const filledData = fillMissingBins(rawData, totalBins);

    window.addEventListener('resize', function() {
      if (familyChart) familyChart.resize();
      if (speciesChart) speciesChart.resize();
    });
    </script>
  </body>
</html>
