<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBP Data File Comparison Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .comparison-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .file-section {
            display: inline-block;
            width: 48%;
            vertical-align: top;
            margin: 1%;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EBP Network Data File Comparison Tool</h1>
        <p>This tool helps you compare the two EBP network data files to identify why one works and the other doesn't.</p>
        
        <div class="comparison-section">
            <h2>Instructions:</h2>
            <ol>
                <li>First, test with the <strong>working file</strong> (EBPnetwork_20250513.js)</li>
                <li>Then test with the <strong>problematic file</strong> (EBPnetwork_20250807.js)</li>
                <li>Compare the results to identify the issue</li>
            </ol>
            <button onclick="loadWorkingFile()">Test Working File (20250513)</button>
            <button onclick="loadProblematicFile()">Test Problematic File (20250807)</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div class="comparison-section">
            <h2>Test Results:</h2>
            <div id="results">
                <p>Click a button above to start testing...</p>
            </div>
        </div>

        <div class="comparison-section">
            <h2>Detailed Analysis:</h2>
            <div id="analysis">
                <p>Analysis will appear here after testing both files...</p>
            </div>
        </div>
    </div>

    <script>
        let workingData = null;
        let problematicData = null;

        function loadWorkingFile() {
            // Remove any existing script
            removeExistingDataScript();
            
            // Load the working file
            const script = document.createElement('script');
            script.src = './geoMap/EBPnetwork_20250513.js';
            script.onload = function() {
                if (typeof projectsData !== 'undefined') {
                    workingData = [...projectsData]; // Make a copy
                    analyzeData('Working File (20250513)', workingData, 'working');
                    delete window.projectsData; // Clean up
                } else {
                    showError('Working file loaded but projectsData is undefined');
                }
            };
            script.onerror = function() {
                showError('Failed to load working file: ./geoMap/EBPnetwork_20250513.js');
            };
            document.head.appendChild(script);
        }

        function loadProblematicFile() {
            // Remove any existing script
            removeExistingDataScript();
            
            // Load the problematic file
            const script = document.createElement('script');
            script.src = './geoMap/EBPnetwork_20250807.js';
            script.onload = function() {
                if (typeof projectsData !== 'undefined') {
                    problematicData = [...projectsData]; // Make a copy
                    analyzeData('Problematic File (20250807)', problematicData, 'problematic');
                    delete window.projectsData; // Clean up
                    
                    // If we have both datasets, compare them
                    if (workingData && problematicData) {
                        compareDatasets();
                    }
                } else {
                    showError('Problematic file loaded but projectsData is undefined - This is likely the issue!');
                }
            };
            script.onerror = function() {
                showError('Failed to load problematic file: ./geoMap/EBPnetwork_20250807.js - File might not exist or has syntax errors');
            };
            document.head.appendChild(script);
        }

        function removeExistingDataScript() {
            const existingScripts = document.querySelectorAll('script[src*="EBPnetwork_"]');
            existingScripts.forEach(script => script.remove());
        }

        function analyzeData(fileName, data, type) {
            const resultsDiv = document.getElementById('results');
            
            let html = `<div class="file-section">`;
            html += `<h3>${fileName}</h3>`;
            
            if (!data) {
                html += `<div class="error">❌ Data is null or undefined</div>`;
            } else if (!Array.isArray(data)) {
                html += `<div class="error">❌ Data is not an array: ${typeof data}</div>`;
            } else {
                html += `<div class="success">✅ Data loaded successfully</div>`;
                html += `<p><strong>Total records:</strong> ${data.length}</p>`;
                
                // Check data structure
                if (data.length > 0) {
                    const firstRecord = data[0];
                    const fields = Object.keys(firstRecord);
                    html += `<p><strong>Fields:</strong> ${fields.join(', ')}</p>`;
                    
                    // Check required fields
                    const requiredFields = ['projectName', 'type', 'latitude', 'longitude'];
                    const missingFields = requiredFields.filter(field => !fields.includes(field));
                    
                    if (missingFields.length > 0) {
                        html += `<div class="error">❌ Missing required fields: ${missingFields.join(', ')}</div>`;
                    } else {
                        html += `<div class="success">✅ All required fields present</div>`;
                    }
                    
                    // Check data types
                    const types = {};
                    data.forEach(record => {
                        const type = record.type || 'Unknown';
                        types[type] = (types[type] || 0) + 1;
                    });
                    html += `<p><strong>Project types:</strong></p>`;
                    html += `<pre>${JSON.stringify(types, null, 2)}</pre>`;
                    
                    // Check for coordinate issues
                    const invalidCoords = data.filter(record => 
                        typeof record.latitude !== 'number' || 
                        typeof record.longitude !== 'number' ||
                        isNaN(record.latitude) || 
                        isNaN(record.longitude)
                    );
                    
                    if (invalidCoords.length > 0) {
                        html += `<div class="error">❌ Invalid coordinates in ${invalidCoords.length} records</div>`;
                        html += `<pre>Sample invalid record: ${JSON.stringify(invalidCoords[0], null, 2)}</pre>`;
                    } else {
                        html += `<div class="success">✅ All coordinates are valid numbers</div>`;
                    }
                    
                    // Sample record
                    html += `<p><strong>Sample record:</strong></p>`;
                    html += `<pre>${JSON.stringify(firstRecord, null, 2)}</pre>`;
                }
            }
            
            html += `</div>`;
            
            if (type === 'working') {
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML += html;
            }
        }

        function compareDatasets() {
            if (!workingData || !problematicData) return;
            
            const analysisDiv = document.getElementById('analysis');
            let html = '<h3>Comparison Analysis:</h3>';
            
            // Basic comparison
            html += `<p><strong>Record count difference:</strong> ${problematicData.length - workingData.length}</p>`;
            
            // Field comparison
            const workingFields = workingData.length > 0 ? Object.keys(workingData[0]) : [];
            const problematicFields = problematicData.length > 0 ? Object.keys(problematicData[0]) : [];
            
            const missingInProblematic = workingFields.filter(field => !problematicFields.includes(field));
            const extraInProblematic = problematicFields.filter(field => !workingFields.includes(field));
            
            if (missingInProblematic.length > 0) {
                html += `<div class="error">❌ Fields missing in problematic file: ${missingInProblematic.join(', ')}</div>`;
            }
            if (extraInProblematic.length > 0) {
                html += `<div class="warning">⚠️ Extra fields in problematic file: ${extraInProblematic.join(', ')}</div>`;
            }
            if (missingInProblematic.length === 0 && extraInProblematic.length === 0) {
                html += `<div class="success">✅ Field structures match</div>`;
            }
            
            // Type comparison
            const workingTypes = {};
            const problematicTypes = {};
            
            workingData.forEach(record => {
                const type = record.type || 'Unknown';
                workingTypes[type] = (workingTypes[type] || 0) + 1;
            });
            
            problematicData.forEach(record => {
                const type = record.type || 'Unknown';
                problematicTypes[type] = (problematicTypes[type] || 0) + 1;
            });
            
            html += '<p><strong>Type distribution comparison:</strong></p>';
            html += '<div style="display: flex;">';
            html += '<div style="flex: 1;"><h4>Working File:</h4><pre>' + JSON.stringify(workingTypes, null, 2) + '</pre></div>';
            html += '<div style="flex: 1;"><h4>Problematic File:</h4><pre>' + JSON.stringify(problematicTypes, null, 2) + '</pre></div>';
            html += '</div>';
            
            analysisDiv.innerHTML = html;
        }

        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += `<div class="error">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '<p>Click a button above to start testing...</p>';
            document.getElementById('analysis').innerHTML = '<p>Analysis will appear here after testing both files...</p>';
            workingData = null;
            problematicData = null;
        }
    </script>
</body>
</html>